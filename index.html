<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Spin">
<meta name="theme-color" content="#0e0e12">
<link rel="apple-touch-icon" id="touchIcon">
<link rel="icon" type="image/png" id="favicon">
<title>Spin The Wheel</title>
<script>
(function(){
  var s = 180, c = document.createElement('canvas');
  c.width = s; c.height = s;
  var x = c.getContext('2d'), cx = s/2, cy = s/2, r = s/2 - 8;

  // Background
  x.fillStyle = '#0e0e12';
  x.beginPath();
  x.roundRect(0, 0, s, s, 36);
  x.fill();

  // Shadow under wheel
  x.save();
  x.shadowColor = 'rgba(0,0,0,0.6)';
  x.shadowBlur = 14;
  x.shadowOffsetY = 4;
  x.beginPath();
  x.arc(cx, cy, r, 0, Math.PI*2);
  x.fillStyle = '#111';
  x.fill();
  x.restore();

  // Wheel segments
  var cols = ['#e94560','#2d7ff9','#18bfbf','#f072a9'];
  var arc = Math.PI*2/4;
  var tilt = -Math.PI/6; // slight rotation offset
  cols.forEach(function(col, i) {
    var sa = tilt + i * arc, ea = sa + arc;
    // Base color
    x.beginPath();
    x.moveTo(cx, cy);
    x.arc(cx, cy, r, sa, ea);
    x.closePath();
    x.fillStyle = col;
    x.fill();
    // 3D gradient overlay per segment
    var grd = x.createRadialGradient(cx - r*0.3, cy - r*0.3, 0, cx, cy, r);
    grd.addColorStop(0, 'rgba(255,255,255,0.25)');
    grd.addColorStop(0.5, 'rgba(255,255,255,0.05)');
    grd.addColorStop(1, 'rgba(0,0,0,0.2)');
    x.beginPath();
    x.moveTo(cx, cy);
    x.arc(cx, cy, r, sa, ea);
    x.closePath();
    x.fillStyle = grd;
    x.fill();
    // Divider lines
    x.beginPath();
    x.moveTo(cx, cy);
    x.lineTo(cx + Math.cos(sa)*r, cy + Math.sin(sa)*r);
    x.strokeStyle = '#0e0e12';
    x.lineWidth = 2.5;
    x.stroke();
  });

  // Outer ring (3D rim)
  x.beginPath();
  x.arc(cx, cy, r, 0, Math.PI*2);
  x.strokeStyle = '#222';
  x.lineWidth = 4;
  x.stroke();
  x.beginPath();
  x.arc(cx, cy, r - 2, 0, Math.PI*2);
  x.strokeStyle = 'rgba(255,255,255,0.08)';
  x.lineWidth = 1.5;
  x.stroke();

  // Gloss highlight (top-left shine)
  var gloss = x.createRadialGradient(cx - r*0.35, cy - r*0.35, 0, cx, cy, r);
  gloss.addColorStop(0, 'rgba(255,255,255,0.3)');
  gloss.addColorStop(0.4, 'rgba(255,255,255,0.05)');
  gloss.addColorStop(1, 'rgba(0,0,0,0)');
  x.beginPath();
  x.arc(cx, cy, r - 3, 0, Math.PI*2);
  x.fillStyle = gloss;
  x.fill();

  // Center hub - outer ring
  x.beginPath();
  x.arc(cx, cy, 18, 0, Math.PI*2);
  var hubGrd = x.createRadialGradient(cx - 4, cy - 4, 0, cx, cy, 18);
  hubGrd.addColorStop(0, '#333');
  hubGrd.addColorStop(1, '#0e0e12');
  x.fillStyle = hubGrd;
  x.fill();
  x.strokeStyle = '#555';
  x.lineWidth = 2;
  x.stroke();

  // Center hub - inner dot
  x.beginPath();
  x.arc(cx, cy, 6, 0, Math.PI*2);
  var dotGrd = x.createRadialGradient(cx - 2, cy - 2, 0, cx, cy, 6);
  dotGrd.addColorStop(0, '#fff');
  dotGrd.addColorStop(1, '#888');
  x.fillStyle = dotGrd;
  x.fill();

  // Pointer triangle at top
  x.save();
  x.shadowColor = 'rgba(0,0,0,0.5)';
  x.shadowBlur = 4;
  x.shadowOffsetY = 1;
  x.beginPath();
  x.moveTo(cx, cy - r + 14);
  x.lineTo(cx - 9, cy - r - 6);
  x.lineTo(cx + 9, cy - r - 6);
  x.closePath();
  var pGrd = x.createLinearGradient(cx, cy - r - 6, cx, cy - r + 14);
  pGrd.addColorStop(0, '#ffffff');
  pGrd.addColorStop(1, '#cccccc');
  x.fillStyle = pGrd;
  x.fill();
  x.restore();

  // Set icons
  var url = c.toDataURL('image/png');
  document.getElementById('touchIcon').href = url;
  document.getElementById('favicon').href = url;
})();
</script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  html {
    height: 100%;
    overflow: hidden;
  }

  body {
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #0e0e12;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    color: #e0e0e0;
    overflow: hidden;
    -webkit-tap-highlight-color: transparent;
    -webkit-text-size-adjust: 100%;
  }

  .screen { display: none; }
  .screen.active { display: flex; }

  /* ── Setup Screen ── */
  #setupScreen {
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 480px;
    height: 100%;
    max-height: 100vh;
    overflow: hidden;
  }

  .setup-top {
    flex-shrink: 0;
    text-align: center;
    padding: 24px 20px 0;
    width: 100%;
  }

  .logo {
    font-size: 1.1rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 6px;
    color: #fff;
    margin-bottom: 24px;
    position: relative;
    display: inline-block;
  }
  .logo::after {
    content: '';
    position: absolute;
    bottom: -8px;
    left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, #fff, transparent);
  }

  .setup-heading {
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 3px;
    color: #666;
    margin-bottom: 16px;
  }

  .setup-scroll {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    width: 100%;
    padding: 0 20px;
    -webkit-overflow-scrolling: touch;
  }

  .players-setup {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 12px;
  }

  .player-row {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #18181e;
    border: 1px solid #252530;
    border-radius: 10px;
    padding: 10px 12px;
    transition: border-color 0.2s;
    min-height: 48px;
  }
  .player-row:focus-within { border-color: #444; }

  .player-num {
    font-size: 0.7rem;
    font-weight: 700;
    color: #444;
    width: 18px;
    text-align: center;
    flex-shrink: 0;
  }

  .player-color-pick {
    width: 32px; height: 32px;
    border-radius: 50%;
    border: 2px solid #333;
    cursor: pointer;
    padding: 0;
    overflow: hidden;
    flex-shrink: 0;
  }
  .player-color-pick::-webkit-color-swatch-wrapper { padding: 0; }
  .player-color-pick::-webkit-color-swatch { border: none; border-radius: 50%; }
  .player-color-pick::-moz-color-swatch { border: none; border-radius: 50%; }

  .player-name-input {
    flex: 1;
    min-width: 0;
    background: none;
    border: none;
    color: #e0e0e0;
    font-family: inherit;
    font-size: 16px; /* 16px prevents iOS zoom */
    font-weight: 500;
    outline: none;
    padding: 4px 0;
  }
  .player-name-input::placeholder { color: #3a3a45; }

  .remove-player {
    background: none;
    border: none;
    color: #444;
    cursor: pointer;
    font-size: 1.3rem;
    padding: 6px 8px;
    border-radius: 8px;
    transition: color 0.15s, background 0.15s;
    line-height: 1;
    flex-shrink: 0;
    -webkit-tap-highlight-color: transparent;
  }
  .remove-player:hover, .remove-player:active { color: #e94560; background: rgba(233,69,96,0.1); }

  .add-player-btn {
    width: 100%;
    padding: 14px;
    background: #18181e;
    border: 1px dashed #2a2a35;
    border-radius: 10px;
    color: #555;
    font-family: inherit;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s;
    min-height: 48px;
    -webkit-tap-highlight-color: transparent;
  }
  .add-player-btn:hover, .add-player-btn:active { border-color: #444; color: #999; }
  .add-player-btn:disabled { opacity: 0.3; cursor: not-allowed; }

  .setup-bottom {
    flex-shrink: 0;
    text-align: center;
    padding: 12px 20px 24px;
    width: 100%;
  }

  .player-count {
    font-size: 0.75rem;
    color: #444;
    margin-bottom: 14px;
  }

  .start-btn {
    padding: 16px 60px;
    font-family: inherit;
    font-size: 0.9rem;
    font-weight: 700;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: #0e0e12;
    background: #fff;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    transition: transform 0.15s, opacity 0.15s;
    -webkit-tap-highlight-color: transparent;
    min-height: 50px;
  }
  .start-btn:hover { transform: scale(1.03); }
  .start-btn:active { transform: scale(0.97); }
  .start-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }

  /* ── Game Screen ── */
  #gameScreen {
    flex-direction: column;
    align-items: center;
    width: 100%;
    height: 100%;
    max-height: 100vh;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 16px 16px 24px;
    -webkit-overflow-scrolling: touch;
  }

  .game-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    max-width: 500px;
    margin-bottom: 16px;
    flex-shrink: 0;
  }
  .game-title {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 4px;
    color: #555;
  }
  .round-info {
    font-size: 0.75rem;
    font-weight: 600;
    color: #444;
  }

  .wheel-wrapper {
    position: relative;
    width: min(380px, calc(100vw - 40px));
    height: min(380px, calc(100vw - 40px));
    margin-bottom: 20px;
    flex-shrink: 0;
  }

  .pointer {
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    width: 0; height: 0;
    border-left: 12px solid transparent;
    border-right: 12px solid transparent;
    border-top: 28px solid #fff;
    filter: drop-shadow(0 2px 8px rgba(0,0,0,0.6));
  }

  canvas#wheel {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    box-shadow: 0 0 0 3px #1e1e28, 0 0 40px rgba(0,0,0,0.6);
    display: block;
  }

  .action-row {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    flex-wrap: wrap;
    justify-content: center;
    flex-shrink: 0;
  }

  .spin-btn {
    padding: 14px 48px;
    font-family: inherit;
    font-size: 0.85rem;
    font-weight: 700;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: #0e0e12;
    background: #fff;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    transition: transform 0.15s, opacity 0.15s;
    -webkit-tap-highlight-color: transparent;
    min-height: 50px;
  }
  .spin-btn:hover { transform: scale(1.03); }
  .spin-btn:active { transform: scale(0.97); }
  .spin-btn:disabled { opacity: 0.25; cursor: not-allowed; transform: none; }

  .rematch-btn, .new-game-btn {
    padding: 14px 22px;
    font-family: inherit;
    font-size: 0.82rem;
    font-weight: 600;
    letter-spacing: 1px;
    color: #888;
    background: none;
    border: 1px solid #2a2a35;
    border-radius: 50px;
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s;
    -webkit-tap-highlight-color: transparent;
    min-height: 50px;
  }
  .rematch-btn:hover, .rematch-btn:active,
  .new-game-btn:hover, .new-game-btn:active { border-color: #555; color: #ccc; }

  .result-area {
    min-height: 36px;
    margin-bottom: 12px;
    text-align: center;
    flex-shrink: 0;
  }
  .result-text {
    font-size: 1rem;
    font-weight: 600;
    animation: fadeUp 0.4s ease;
  }
  .result-text.eliminated { color: #e94560; }
  .result-text.winner {
    font-size: 1.3rem;
    font-weight: 800;
    color: #ffd700;
    text-shadow: 0 0 30px rgba(255,215,0,0.3);
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .scoreboard {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 500px;
    padding-bottom: 10px;
  }
  .sb-tag {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 5px 12px 5px 7px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    background: #18181e;
    border: 1px solid #252530;
    transition: opacity 0.4s;
  }
  .sb-tag .sb-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .sb-tag.out {
    opacity: 0.25;
    text-decoration: line-through;
  }

  /* ── Elimination Overlay ── */
  .elim-overlay {
    position: fixed;
    inset: 0;
    z-index: 60;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
  }

  .elim-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    animation: elimIn 0.5s ease forwards, elimOut 0.5s ease 2s forwards;
  }

  .elim-flash {
    position: fixed;
    inset: 0;
    z-index: 59;
    pointer-events: none;
    animation: flashBg 0.6s ease forwards;
  }

  .elim-color-ring {
    width: 72px; height: 72px;
    border-radius: 50%;
    border: 4px solid;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: ringPulse 0.6s ease;
  }
  .elim-x {
    font-size: 2rem;
    font-weight: 800;
    color: #e94560;
    line-height: 1;
  }

  .elim-name {
    font-size: 1.4rem;
    font-weight: 800;
  }

  .elim-label {
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 4px;
    text-transform: uppercase;
    color: #e94560;
  }

  @keyframes elimIn {
    from { opacity: 0; transform: scale(0.5); }
    to { opacity: 1; transform: scale(1); }
  }
  @keyframes elimOut {
    from { opacity: 1; transform: scale(1); }
    to { opacity: 0; transform: scale(0.8) translateY(-20px); }
  }
  @keyframes flashBg {
    0% { background: rgba(233,69,96,0.3); }
    100% { background: transparent; }
  }
  @keyframes ringPulse {
    0% { transform: scale(0.3); opacity: 0; }
    50% { transform: scale(1.15); }
    100% { transform: scale(1); opacity: 1; }
  }

  /* ── Winner Overlay ── */
  .winner-overlay {
    position: fixed;
    inset: 0;
    z-index: 60;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
  }
  .winner-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    animation: winnerIn 0.6s ease forwards;
  }
  .winner-crown {
    font-size: 2.8rem;
    animation: crownBounce 0.6s ease;
  }
  .winner-name {
    font-size: 1.8rem;
    font-weight: 800;
  }
  .winner-label {
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 5px;
    text-transform: uppercase;
    color: #ffd700;
  }

  @keyframes winnerIn {
    from { opacity: 0; transform: scale(0.3); }
    to { opacity: 1; transform: scale(1); }
  }
  @keyframes crownBounce {
    0% { transform: translateY(-40px) scale(0); }
    60% { transform: translateY(5px) scale(1.1); }
    100% { transform: translateY(0) scale(1); }
  }

  #confetti {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 50;
  }

  /* ── Small phones ── */
  @media (max-width: 400px) {
    .logo { font-size: 0.95rem; letter-spacing: 4px; margin-bottom: 18px; }
    .setup-heading { font-size: 0.7rem; margin-bottom: 12px; }
    .player-row { padding: 8px 10px; gap: 8px; }
    .player-color-pick { width: 28px; height: 28px; }
    .start-btn { padding: 14px 44px; font-size: 0.85rem; }
    .spin-btn { padding: 14px 36px; }
    .rematch-btn, .new-game-btn { padding: 12px 18px; font-size: 0.78rem; }
    .elim-name { font-size: 1.2rem; }
    .winner-name { font-size: 1.4rem; }
    .winner-crown { font-size: 2.2rem; }
  }

  /* ── Short screens (landscape / small height) ── */
  @media (max-height: 650px) {
    .wheel-wrapper {
      width: min(280px, calc(100vw - 40px));
      height: min(280px, calc(100vw - 40px));
      margin-bottom: 12px;
    }
    .game-header { margin-bottom: 8px; }
    .action-row { margin-bottom: 10px; }
    .result-area { min-height: 28px; margin-bottom: 8px; }
    .setup-top { padding-top: 12px; }
    .logo { margin-bottom: 14px; }
  }

  @media (max-height: 500px) {
    .wheel-wrapper {
      width: min(200px, calc(100vh - 200px));
      height: min(200px, calc(100vh - 200px));
    }
  }
</style>
</head>
<body>

<!-- ── SETUP SCREEN ── -->
<div class="screen active" id="setupScreen">
  <div class="setup-top">
    <div class="logo">Spin the Wheel</div>
    <div class="setup-heading">Add Players</div>
  </div>
  <div class="setup-scroll">
    <div class="players-setup" id="playersSetup"></div>
    <button class="add-player-btn" id="addPlayerBtn">+ Add Player</button>
  </div>
  <div class="setup-bottom">
    <div class="player-count" id="playerCount"></div>
    <button class="start-btn" id="startBtn">Start Game</button>
  </div>
</div>

<!-- ── GAME SCREEN ── -->
<div class="screen" id="gameScreen">
  <div class="game-header">
    <div class="game-title">Spin the Wheel</div>
    <div class="round-info" id="roundInfo"></div>
  </div>

  <div class="wheel-wrapper">
    <div class="pointer"></div>
    <canvas id="wheel" width="760" height="760"></canvas>
  </div>

  <div class="action-row">
    <button class="spin-btn" id="spinBtn">Spin</button>
    <button class="rematch-btn" id="rematchBtn">Rematch</button>
    <button class="new-game-btn" id="newGameBtn">Edit Players</button>
  </div>

  <div class="result-area" id="resultArea"></div>
  <div class="scoreboard" id="scoreboard"></div>
</div>

<canvas id="confetti"></canvas>

<script>
const PALETTE = [
  '#e94560','#2d7ff9','#18bfbf','#f072a9',
  '#f5a623','#7c5cfc','#23c45e','#ff6b3d',
  '#c4437b','#3ec6e0'
];

// ── Audio ──
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function resumeAudio() {
  if (audioCtx.state === 'suspended') audioCtx.resume();
}
document.addEventListener('touchstart', resumeAudio, { once: true });
document.addEventListener('click', resumeAudio, { once: true });

function playTick() {
  const o = audioCtx.createOscillator(), g = audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  o.type = 'sine';
  o.frequency.setValueAtTime(1800, audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.04);
  g.gain.setValueAtTime(0.15, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.06);
  o.start(); o.stop(audioCtx.currentTime + 0.06);
}

function playEliminate() {
  [0, 0.15, 0.3].forEach((d, i) => {
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    o.type = 'sawtooth';
    const f = 400 - i * 80;
    o.frequency.setValueAtTime(f, audioCtx.currentTime + d);
    o.frequency.exponentialRampToValueAtTime(f * 0.7, audioCtx.currentTime + d + 0.15);
    g.gain.setValueAtTime(0.1, audioCtx.currentTime + d);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + d + 0.18);
    o.start(audioCtx.currentTime + d); o.stop(audioCtx.currentTime + d + 0.2);
  });
}

function playWinner() {
  [523,659,784,1047,784,1047].forEach((f, i) => {
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    o.type = 'square';
    o.frequency.setValueAtTime(f, audioCtx.currentTime + i * 0.12);
    g.gain.setValueAtTime(0.1, audioCtx.currentTime + i * 0.12);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + i * 0.12 + 0.25);
    o.start(audioCtx.currentTime + i * 0.12); o.stop(audioCtx.currentTime + i * 0.12 + 0.25);
  });
}

function playSpinStart() {
  const o = audioCtx.createOscillator(), g = audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  o.type = 'sine';
  o.frequency.setValueAtTime(300, audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(900, audioCtx.currentTime + 0.3);
  g.gain.setValueAtTime(0.12, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.35);
  o.start(); o.stop(audioCtx.currentTime + 0.35);
}

// ── DOM ──
const setupScreen = document.getElementById('setupScreen');
const gameScreen = document.getElementById('gameScreen');
const playersSetup = document.getElementById('playersSetup');
const addPlayerBtn = document.getElementById('addPlayerBtn');
const playerCountEl = document.getElementById('playerCount');
const startBtn = document.getElementById('startBtn');

const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');
const spinBtn = document.getElementById('spinBtn');
const rematchBtn = document.getElementById('rematchBtn');
const newGameBtn = document.getElementById('newGameBtn');
const resultArea = document.getElementById('resultArea');
const roundInfo = document.getElementById('roundInfo');
const scoreboard = document.getElementById('scoreboard');
const confettiCanvas = document.getElementById('confetti');
const confettiCtx = confettiCanvas.getContext('2d');

const SIZE = 760, CENTER = SIZE / 2, RADIUS = SIZE / 2 - 16;

let savedPlayers = [
  { name: '', color: PALETTE[0] },
  { name: '', color: PALETTE[1] },
];
let players = [];
let segments = [];
let currentAngle = 0;
let spinning = false;
let gameOver = false;
let roundNum = 0;
let confettiPieces = [], confettiAnim = null;
let elimTimeout = null;

// ── Setup Screen ──
function loadSetup() {
  players = savedPlayers.map(p => ({ ...p }));
  renderSetup();
}

function renderSetup() {
  playersSetup.innerHTML = '';
  players.forEach((p, i) => {
    const row = document.createElement('div');
    row.className = 'player-row';
    row.innerHTML = `
      <span class="player-num">${i + 1}</span>
      <input type="color" class="player-color-pick" value="${p.color}" data-i="${i}" />
      <input type="text" class="player-name-input" value="${p.name}"
        placeholder="Player ${i + 1}" maxlength="16" data-i="${i}" />
      ${players.length > 2 ? `<button class="remove-player" data-i="${i}">&times;</button>` : ''}
    `;
    playersSetup.appendChild(row);
  });

  playersSetup.querySelectorAll('.player-name-input').forEach(el => {
    el.addEventListener('input', e => { players[+e.target.dataset.i].name = e.target.value; });
  });
  playersSetup.querySelectorAll('.player-color-pick').forEach(el => {
    el.addEventListener('input', e => { players[+e.target.dataset.i].color = e.target.value; });
  });
  playersSetup.querySelectorAll('.remove-player').forEach(el => {
    el.addEventListener('click', e => {
      players.splice(+e.target.dataset.i, 1);
      renderSetup();
    });
  });

  addPlayerBtn.disabled = players.length >= 10;
  playerCountEl.textContent = `${players.length} / 10 players`;
  startBtn.disabled = players.length < 2;
}

addPlayerBtn.addEventListener('click', () => {
  if (players.length >= 10) return;
  players.push({ name: '', color: PALETTE[players.length % PALETTE.length] });
  renderSetup();
  const inputs = playersSetup.querySelectorAll('.player-name-input');
  inputs[inputs.length - 1].focus();
});

startBtn.addEventListener('click', () => {
  players.forEach((p, i) => { if (!p.name.trim()) p.name = `Player ${i + 1}`; });
  savedPlayers = players.map(p => ({ ...p }));
  startGame();
});

// ── Game ──
function startGame() {
  segments = savedPlayers.map(p => ({ ...p, alive: true }));
  currentAngle = 0;
  spinning = false;
  gameOver = false;
  roundNum = 0;
  resultArea.innerHTML = '';
  spinBtn.disabled = false;
  spinBtn.style.display = '';
  stopConfetti();
  clearElimOverlay();

  setupScreen.classList.remove('active');
  gameScreen.classList.add('active');
  updateRoundInfo();
  updateScoreboard();
  drawWheel();
}

function goToSetup() {
  gameScreen.classList.remove('active');
  setupScreen.classList.add('active');
  stopConfetti();
  clearElimOverlay();
  loadSetup();
}

rematchBtn.addEventListener('click', () => { startGame(); });
newGameBtn.addEventListener('click', goToSetup);

function alive() { return segments.filter(s => s.alive); }

function updateRoundInfo() {
  const a = alive().length;
  roundInfo.textContent = gameOver ? '' : `${a} remaining`;
}

function updateScoreboard() {
  scoreboard.innerHTML = segments.map(s =>
    `<div class="sb-tag${s.alive ? '' : ' out'}">
      <span class="sb-dot" style="background:${s.color}"></span>${s.name}
    </div>`
  ).join('');
}

// ── Elimination Animation ──
function clearElimOverlay() {
  document.querySelectorAll('.elim-overlay, .elim-flash, .winner-overlay').forEach(el => el.remove());
  if (elimTimeout) { clearTimeout(elimTimeout); elimTimeout = null; }
}

function showEliminationAnim(loser, callback) {
  clearElimOverlay();

  const flash = document.createElement('div');
  flash.className = 'elim-flash';
  document.body.appendChild(flash);

  const overlay = document.createElement('div');
  overlay.className = 'elim-overlay';
  overlay.innerHTML = `
    <div class="elim-card">
      <div class="elim-color-ring" style="border-color:${loser.color}">
        <span class="elim-x">&times;</span>
      </div>
      <div class="elim-name" style="color:${loser.color}">${loser.name}</div>
      <div class="elim-label">Eliminated</div>
    </div>
  `;
  document.body.appendChild(overlay);

  playEliminate();

  elimTimeout = setTimeout(() => {
    flash.remove();
    overlay.remove();
    callback();
  }, 2400);
}

function showWinnerAnim(winner) {
  clearElimOverlay();

  const overlay = document.createElement('div');
  overlay.className = 'winner-overlay';
  overlay.innerHTML = `
    <div class="winner-card">
      <div class="winner-crown">&#128081;</div>
      <div class="winner-name" style="color:${winner.color}">${winner.name}</div>
      <div class="winner-label">Winner</div>
    </div>
  `;
  document.body.appendChild(overlay);

  playWinner();
  startConfetti(winner.color);

  elimTimeout = setTimeout(() => { overlay.remove(); }, 4000);
}

// ── Drawing ──
function drawWheel(flash_seg) {
  ctx.clearRect(0, 0, SIZE, SIZE);
  const a = alive();
  if (!a.length) return;
  const arc = (2 * Math.PI) / a.length;

  a.forEach((seg, i) => {
    const sa = currentAngle + i * arc;
    const ea = sa + arc;

    ctx.beginPath();
    ctx.moveTo(CENTER, CENTER);
    ctx.arc(CENTER, CENTER, RADIUS, sa, ea);
    ctx.closePath();

    ctx.fillStyle = (flash_seg && seg === flash_seg) ? '#fff' : seg.color;
    ctx.fill();

    ctx.lineWidth = 2;
    ctx.strokeStyle = '#0e0e12';
    ctx.stroke();

    const mid = sa + arc / 2;
    const tr = RADIUS * 0.58;
    const tx = CENTER + Math.cos(mid) * tr;
    const ty = CENTER + Math.sin(mid) * tr;
    const maxFont = a.length <= 4 ? 30 : a.length <= 6 ? 24 : 18;
    const fs = Math.min(maxFont, 200 / (seg.name.length || 1));

    ctx.save();
    ctx.translate(tx, ty);
    ctx.rotate(mid);
    ctx.fillStyle = (flash_seg && seg === flash_seg) ? '#0e0e12' : '#fff';
    ctx.font = `700 ${fs}px Inter, system-ui, sans-serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.shadowColor = 'rgba(0,0,0,0.5)';
    ctx.shadowBlur = 4;
    ctx.fillText(seg.name, 0, 0);
    ctx.restore();
  });

  ctx.beginPath();
  ctx.arc(CENTER, CENTER, 20, 0, 2 * Math.PI);
  ctx.fillStyle = '#0e0e12';
  ctx.fill();
  ctx.lineWidth = 3;
  ctx.strokeStyle = '#333';
  ctx.stroke();
}

function getLoser() {
  const a = alive();
  const arc = (2 * Math.PI) / a.length;
  let rel = (-Math.PI / 2 - currentAngle) % (2 * Math.PI);
  if (rel < 0) rel += 2 * Math.PI;
  return a[Math.floor(rel / arc)];
}

function flashSegment(seg, times, cb) {
  let count = 0;
  const interval = setInterval(() => {
    drawWheel(count % 2 === 0 ? seg : null);
    count++;
    if (count >= times * 2) {
      clearInterval(interval);
      drawWheel();
      cb();
    }
  }, 120);
}

function spin() {
  if (spinning || gameOver) return;
  resumeAudio();
  const a = alive();
  if (a.length <= 1) return;

  spinning = true;
  spinBtn.disabled = true;
  resultArea.innerHTML = '';
  roundNum++;
  playSpinStart();

  const totalRot = (Math.random() * 5 + 5) * 2 * Math.PI + Math.random() * 2 * Math.PI;
  const startA = currentAngle;
  const dur = 4200;
  const startT = performance.now();
  const arc = (2 * Math.PI) / a.length;
  let lastSeg = -1;

  function animate(now) {
    const t = Math.min((now - startT) / dur, 1);
    const ease = 1 - Math.pow(1 - t, 3);
    currentAngle = startA + totalRot * ease;
    drawWheel();

    let rel = (-Math.PI / 2 - currentAngle) % (2 * Math.PI);
    if (rel < 0) rel += 2 * Math.PI;
    const si = Math.floor(rel / arc);
    if (si !== lastSeg) { playTick(); lastSeg = si; }

    if (t < 1) {
      requestAnimationFrame(animate);
    } else {
      currentAngle = currentAngle % (2 * Math.PI);
      const loser = getLoser();

      flashSegment(loser, 4, () => {
        loser.alive = false;
        const rem = alive();

        if (rem.length === 1) {
          gameOver = true;
          spinning = false;
          const w = rem[0];
          drawWheel();
          updateScoreboard();
          updateRoundInfo();

          setTimeout(() => {
            showWinnerAnim(w);
            resultArea.innerHTML = `<div class="result-text winner">${w.name} wins!</div>`;
            spinBtn.disabled = true;
          }, 300);
        } else {
          showEliminationAnim(loser, () => {
            spinning = false;
            spinBtn.disabled = false;
            resultArea.innerHTML = `<div class="result-text eliminated">${loser.name} eliminated</div>`;
          });
          drawWheel();
          updateScoreboard();
          updateRoundInfo();
        }
      });
    }
  }
  requestAnimationFrame(animate);
}

spinBtn.addEventListener('click', spin);

// ── Confetti ──
function resizeConfetti() {
  confettiCanvas.width = window.innerWidth;
  confettiCanvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeConfetti);
resizeConfetti();

function startConfetti(accent) {
  confettiPieces = [];
  const cols = ['#ffd700','#fff', accent, '#e94560','#2d7ff9','#18bfbf','#f5a623'];
  for (let i = 0; i < 120; i++) {
    confettiPieces.push({
      x: Math.random() * confettiCanvas.width,
      y: Math.random() * -confettiCanvas.height,
      w: Math.random() * 8 + 4, h: Math.random() * 5 + 2,
      color: cols[Math.floor(Math.random() * cols.length)],
      vx: (Math.random() - 0.5) * 3, vy: Math.random() * 3 + 1.5,
      rot: Math.random() * 360, rv: (Math.random() - 0.5) * 8,
    });
  }
  (function loop() {
    confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
    confettiPieces.forEach(p => {
      p.x += p.vx; p.y += p.vy; p.rot += p.rv;
      if (p.y > confettiCanvas.height + 20) { p.y = -20; p.x = Math.random() * confettiCanvas.width; }
      confettiCtx.save();
      confettiCtx.translate(p.x, p.y);
      confettiCtx.rotate(p.rot * Math.PI / 180);
      confettiCtx.fillStyle = p.color;
      confettiCtx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
      confettiCtx.restore();
    });
    confettiAnim = requestAnimationFrame(loop);
  })();
}

function stopConfetti() {
  if (confettiAnim) cancelAnimationFrame(confettiAnim);
  confettiAnim = null;
  confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
}

// ── Init ──
loadSetup();
</script>
</body>
</html>
